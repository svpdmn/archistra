<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>archistra chat</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="scripts/tailwind-theme.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Play:wght@400;700&family=Tektur:wght@400;500;600;700;800;900&family=Geo:wght@400&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles/theme.css">
</head>
<body class="grid-pattern">
    <div id="site-nav" data-page="chat"></div>

    <main class="relative z-10 min-h-screen px-4 pt-24 pb-8 sm:px-6 sm:pt-28 u-font-ui">
        <section class="mx-auto flex min-h-[72vh] w-full max-w-5xl flex-col overflow-hidden card-strong rounded-xl2" style="border: 1px solid rgba(255, 255, 255, 0.14);">
            <div class="border-b u-border-subtle px-4 py-5 sm:px-6 sm:py-6 text-center">
                <div class="u-font-code text-accent-400 text-xs tracking-widest mb-2">CHAT INTERFACE</div>
                <h2 class="text-2xl sm:text-3xl font-display font-bold">Conversation Workspace</h2>
            </div>
            <div class="border-b u-border-subtle px-4 py-3 sm:px-6">
                <span class="badge badge-chat u-font-code tracking-wide">Session: prototype-chat-001</span>
            </div>

                <div id="messages" class="flex-1 space-y-4 overflow-y-auto px-4 py-5 sm:px-6">
                    <article class="max-w-3xl">
                        <p class="mb-2 u-font-code text-[11px] tracking-wider text-accent-400">ASSISTANT</p>
                        <div class="card rounded-md p-4" style="border: 0.5px solid rgba(255, 255, 255, 0.10);">
                            <p class="u-text-1 u-font-code text-[11px]">Hello. I can help draft architecture notes, summarize requirements, and generate implementation plans.</p>
                        </div>
                    </article>
                </div>

                <form id="composer" class="border-t u-border-subtle p-4 sm:p-6">
                    <label for="prompt" class="mb-2 block u-font-code text-[11px] tracking-wider text-accent-400">MESSAGE</label>
                    <div class="flex flex-col gap-3 sm:flex-row">
                    <textarea id="prompt" name="prompt" rows="2" class="chat-copy card w-full resize-none rounded-none bg-transparent px-4 py-3 u-text-1 placeholder:text-white/50 focus:outline-none" style="border: 0.5px solid rgba(255, 255, 255, 0.10);" placeholder="Type your message..." required></textarea>
                    <button type="submit" class="btn btn-primary w-full sm:w-auto px-6 py-3 text-[11px] font-semibold u-font-code">Send</button>
                </div>
                <div class="mt-2">
                    <span class="badge badge-chat u-font-code tracking-wide">Backend target: OpenRouter via /api/chat.</span>
                </div>
            </form>
        </section>
    </main>

    <div id="site-footer"></div>

    <script src="scripts/auth-ui.js"></script>
    <script src="scripts/navbar.js"></script>
    <script src="scripts/footer.js"></script>
    <script>
        const composer = document.getElementById('composer');
        const prompt = document.getElementById('prompt');
        const messages = document.getElementById('messages');
        const submitButton = composer.querySelector('button[type="submit"]');

        const messageState = [
            {
                role: 'assistant',
                content: 'Hello. I can help draft architecture notes, summarize requirements, and generate implementation plans.'
            }
        ];

        function createMessageBlock(role, content) {
            const block = document.createElement('article');
            block.className = role === 'user' ? 'ml-auto max-w-3xl' : 'max-w-3xl';
            block.innerHTML = `
                <p class="mb-2 ${role === 'user' ? 'text-right text-accent-200' : 'text-accent-400'} u-font-code text-[11px] tracking-wider">${role === 'user' ? 'YOU' : 'ASSISTANT'}</p>
                <div class="card rounded-md p-4" style="border: 0.5px solid rgba(255, 255, 255, 0.10);">
                    <p class="u-text-1 u-font-code text-[11px]"></p>
                </div>
            `;
            block.querySelector('p.u-text-1').textContent = content;
            messages.appendChild(block);
            messages.scrollTop = messages.scrollHeight;
            return block;
        }

        async function submitChat(messagesPayload) {
            const response = await fetch('/api/chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify({ messages: messagesPayload })
            });

            const body = await response.json().catch(() => null);
            if (!response.ok) {
                const errorText = body && body.error ? body.error : `Request failed with status ${response.status}`;
                const error = new Error(errorText);
                error.status = response.status;
                throw error;
            }

            return body;
        }

        composer.addEventListener('submit', async (event) => {
            event.preventDefault();
            const text = prompt.value.trim();
            if (!text) return;

            const originalButtonText = submitButton.textContent;
            submitButton.disabled = true;
            submitButton.textContent = 'Sending...';

            createMessageBlock('user', text);
            messageState.push({ role: 'user', content: text });
            prompt.value = '';

            const thinkingBlock = createMessageBlock('assistant', 'Thinking...');

            try {
                const result = await submitChat(messageState);
                const assistantText = typeof result.outputText === 'string' && result.outputText.trim()
                    ? result.outputText.trim()
                    : 'No response text returned by model.';
                thinkingBlock.querySelector('p.u-text-1').textContent = assistantText;
                messageState.push({ role: 'assistant', content: assistantText });
            } catch (error) {
                const status = Number(error && error.status) || 0;
                let message = error instanceof Error ? error.message : 'Unknown request error.';
                if (status === 401) message = 'Session expired. Sign in again at /auth/login?returnTo=/chat.html';
                if (status === 403) message = 'Access denied for current role/org.';
                thinkingBlock.querySelector('p.u-text-1').textContent = `Error: ${message}`;
            } finally {
                submitButton.disabled = false;
                submitButton.textContent = originalButtonText;
                messages.scrollTop = messages.scrollHeight;
            }
        });
    </script>
</body>
</html>
